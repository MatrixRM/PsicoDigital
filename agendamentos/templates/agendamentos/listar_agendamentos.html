{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">üìÖ Agendamentos</h2>

    <!-- Secret√°rias e Profissionais de Sa√∫de podem criar novos agendamntos -->
    {% if user.is_authenticated and user.tipo_usuario in "SECRETARIA, PROFISSIONAL_SAUDE" %}
        <a href="{% url 'criar_agendamento' %}" class="btn btn-primary mb-3">
            <i class="fas fa-calendar-plus"></i> Novo Agendamento
        </a>
    {% endif %}

    <div class="table-responsive">
        <table class="table table-striped">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Paciente</th>
                    <th>Profissional de Sa√∫de</th>
                    <th>Data</th>
                    <th>Hora</th>
                    <th>Status</th>
                    <th class="text-center">A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for agendamento in agendamentos %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ agendamento.paciente.nome }}</td>
                    <td>{{ agendamento.psicologo.username }}</td> <!-- Exibe o nome do profissional de sa√∫de -->
                    <td>{{ agendamento.data }}</td>
                    <td>{{ agendamento.hora }}</td>
                    <td>
                        {% if agendamento.status == "Em andamento" %}
                            <span class="badge bg-warning text-dark">üü° Em andamento</span>
                        {% elif agendamento.status == "Conclu√≠do" %}
                            <span class="badge bg-success">‚úÖ Conclu√≠do</span>
                        {% else %}
                            <span class="badge bg-danger">‚ùå Cancelado</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <!-- Apenas Psic√≥logos podem atender consultas se o status for "Em andamento" -->
                        {% if user.is_authenticated and user.tipo_usuario == "PSICOLOGO" and agendamento.psicologo == user and agendamento.status == "Em andamento" %}
                            <a href="{% url 'realizar_consulta' agendamento.id %}" class="btn btn-primary">
                                <i class="fas fa-stethoscope"></i> Atender
                            </a>
                        {% endif %}

                        <!-- Psic√≥logos e Secret√°rias podem editar -->
                        {% if user.is_authenticated and user.tipo_usuario in "PSICOLOGO, SECRETARIA" %}
                            <a href="{% url 'editar_agendamento' agendamento.id %}" class="btn btn-warning">‚úèÔ∏è Editar</a>
                        {% endif %}

                        <!-- Apenas Secret√°rias podem excluir -->
                        {% if user.is_authenticated and user.tipo_usuario == "SECRETARIA" %}
                            <form action="{% url 'excluir_agendamento' agendamento.id %}" method="post" style="display:inline;"
                                  onsubmit="return confirm('Tem certeza que deseja excluir este agendamento?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger">üóëÔ∏è Excluir</button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">Nenhum agendamento encontrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
